<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Hacking Whonix onto Hyper-V - duck's pond</title><meta name=description content="Introduction Prerequisites Installation  Extraction Conversion Networking  Create the internal switch  Create the gateway Configure the network   Create the private switch   VM creation  Gateway Workstation Hyper-V kernel modules     Generation 2 installation  Converting to vhdx Install grub-efi Partitioning  Mount partitions Load the efivars kernel module Finish the GRUB install Unmount and reboot   Secure Boot    Introduction This guide aims to get the Whonix™ operating system running on Hyper-V."><meta name=author content="duck"><link href=https://qua3k.github.io/an-old-hope.min.css rel=stylesheet><link href=https://qua3k.github.io/style.css rel=stylesheet><link href=https://qua3k.github.io/custom.css rel=stylesheet><link rel=apple-touch-icon href=https://qua3k.github.io/apple-touch-icon.png><link rel=icon href=https://qua3k.github.io/favicon.ico><meta name=generator content="Hugo 0.85.0"><script>function setTheme(){if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');return}const c=new Date,g=localStorage.getItem('date'),d=String(c.getMonth()+1)+'.'+String(c.getDate()),e=c.getTime();let a,b;function f(){if(e>a&&e<b)return;document.body.classList.add('dark')}d!==g?(fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215').then(a=>a.json()).then(c=>{a=c.sunrise.split(':').map(Number),b=c.sunset.split(':').map(Number)}).catch(()=>{a=[7,0],b=[19,0]}).finally(()=>{a=c.setHours(a[0],a[1],0),b=c.setHours(b[0],b[1],0),f(),localStorage.setItem('sunrise',a),localStorage.setItem('sunset',b)}),localStorage.setItem('date',d)):(a=Number(localStorage.getItem('sunrise')),b=Number(localStorage.getItem('sunset')),f())}</script></head><body class=single><script>setTheme()</script><header class=header><nav class=nav><p class=logo><a href=https://qua3k.github.io/>duck's pond</a></p><ul class=menu><li><a href=/about/>about</a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Hacking Whonix onto Hyper-V</h1><div class=post-meta>duck · June 5, 2021</div></header><div class=post-content><ul><li><a href=#introduction>Introduction</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#installation>Installation</a><ul><li><a href=#extraction>Extraction</a></li><li><a href=#conversion>Conversion</a></li><li><a href=#networking>Networking</a><ul><li><a href=#create-the-internal-switch>Create the internal switch</a><ul><li><a href=#create-the-gateway>Create the gateway</a></li><li><a href=#configure-the-network>Configure the network</a></li></ul></li><li><a href=#create-the-private-switch>Create the private switch</a></li></ul></li><li><a href=#vm-creation>VM creation</a><ul><li><a href=#gateway>Gateway</a></li><li><a href=#workstation>Workstation</a></li><li><a href=#hyper-v-kernel-modules>Hyper-V kernel modules</a></li></ul></li></ul></li><li><a href=#generation-2-installation>Generation 2 installation</a><ul><li><a href=#converting-to-vhdx>Converting to vhdx</a></li><li><a href=#install-grub-efi>Install grub-efi</a></li><li><a href=#partitioning>Partitioning</a><ul><li><a href=#mount-partitions>Mount partitions</a></li><li><a href=#load-the-efivars-kernel-module>Load the efivars kernel module</a></li><li><a href=#finish-the-grub-install>Finish the GRUB install</a></li><li><a href=#unmount-and-reboot>Unmount and reboot</a></li></ul></li><li><a href=#secure-boot>Secure Boot</a></li></ul></li></ul><h2 id=introduction>Introduction</h2><p>This guide aims to get the Whonix™ operating system running on Hyper-V. This guide does not expect Virtualbox specific features such as guest additions to work and does not make any effort to make them work.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>The latest <a href=https://www.whonix.org/wiki/VirtualBox>Whonix for VirtualBox</a></li><li>The latest <a href=https://www.virtualbox.org/wiki/Downloads>VirtualBox for Windows</a></li><li><code>qemu-img</code><a href=https://gitlab.com/qemu-project/qemu/-/issues/250>is broken when trying to convert to vhdx</a> and is not supported.</li></ul><p>It is strongly recommended to verify the authenticity of the downloaded files.</p><h2 id=installation>Installation</h2><h3 id=extraction>Extraction</h3><p>Use <code>tar</code> or another archive utility of choice to extract the <code>.ova</code> archive.</p><p>This should produce two <code>.vmdk</code> virtual disks.</p><h3 id=conversion>Conversion</h3><p>Convert the two virtual disks.</p><pre><code>VBoxManage.exe clonehd source.vmdk target.vhd --format vhd
</code></pre><h3 id=networking>Networking</h3><h4 id=create-the-internal-switch>Create the internal switch</h4><p>Create an internal switch and <a href=https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/setup-nat-network#create-a-nat-virtual-network>get the interface index.</a></p><h5 id=create-the-gateway>Create the gateway</h5><pre><code>New-NetIPAddress -IPAddress 10.0.2.2 -PrefixLength 24 -InterfaceIndex &lt;ifIndex&gt;
</code></pre><h5 id=configure-the-network>Configure the network</h5><pre><code>New-NetNat -Name Gateway -InternalIPInterfaceAddressPrefix 10.0.2.0/24
</code></pre><h4 id=create-the-private-switch>Create the private switch</h4><p>This switch is used to connect the Gateway to Workstation.</p><pre><code>New-VMSwitch -SwitchName Whonix -SwitchType Private
</code></pre><h3 id=vm-creation>VM creation</h3><p>There should be two Generation 1 virtual machines. Whonix does not have UEFI support and will not boot on Generation 2 VMs.</p><p>UEFI setup so that Whonix will run in Generation 2 virtual machines is detailed <a href=#generation-2-installation>later</a>.</p><h4 id=gateway>Gateway</h4><p>Create a Generation 1 virtual machine and add your <code>whonix-xxxx-disk001.vhd</code> virtual disk.</p><p>Create two virtual network adapters, one connecting to the Gateway virtual switch, and one connecting to the Whonix virtual switch.</p><h4 id=workstation>Workstation</h4><p>Create a Generation 1 virtual machine and add your <code>whonix-xxxx-disk002.vhd</code> virtual disk.</p><p>Create a virtual network adapter connecting to the Whonix virtual switch.</p><h4 id=hyper-v-kernel-modules>Hyper-V kernel modules</h4><p>To get networking working on Whonix, you need to enable some <a href=https://blog.jitdor.com/2020/02/08/enable-hyper-v-integration-services-for-your-ubuntu-guest-vms/>kernel modules</a> for Hyper-V integration.</p><pre><code>sudo printf &quot;hv_utils \nhv_vmbus \nhv_storvsc \nhv_blksvc \nhv_netvsc&quot; &gt;&gt; /etc/initramfs-tools/modules
sudo update-initramfs -u
</code></pre><h2 id=generation-2-installation>Generation 2 installation</h2><p>Do not attempt to execute any of the steps below unless you are familiar with the implications of performing them incorrectly.</p><h3 id=converting-to-vhdx>Converting to vhdx</h3><p>Generation 2 virtual machines only support <code>.vhdx</code> disks. You should convert the disks within the Hyper-V Manager UI or with the PowerShell cmdlet <code>Convert-VHD</code>.</p><h3 id=install-grub-efi>Install grub-efi</h3><p>Boot up your existing Generation 1 virtual machine and install <code>grub-efi-amd64</code>.</p><pre><code>sudo apt update
sudo apt install grub-efi-amd64
sudo apt purge grub-pc-bin
</code></pre><h3 id=partitioning>Partitioning</h3><p>Resize /dev/sda1 to create some free space for the EFi system partition with <code>cfdisk /dev/sda</code>.</p><p>Use <code>gdisk /dev/sda</code> to convert the partition table to GPT and create the ESP on <code>/dev/sda2</code>.</p><h4 id=format-the-efi-partition>Format the EFI partition</h4><pre><code>sudo mkfs.fat -F 32 /dev/sda2
</code></pre><h4 id=mount-partitions>Mount partitions</h4><pre><code>sudo mount /dev/sda1 /mnt
sudo mkdir -p /mnt/boot/efi
sudo mount /dev/sda2 /mnt/boot/efi
for d in dev proc run sys; do sudo mount -B /$d /mnt/$d; done
</code></pre><h4 id=load-the-efivars-kernel-module>Load the efivars kernel module</h4><pre><code>sudo modprobe efivars
</code></pre><h4 id=finish-the-grub-install>Finish the GRUB install</h4><pre><code>sudo chroot /mnt
sudo grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=DEBIAN
sudo grub-mkconfig -o /boot/grub/grub.cfg
</code></pre><h4 id=unmount-and-reboot>Unmount and reboot</h4><pre><code>sudo umount -R /mnt
sudo reboot
</code></pre><h3 id=secure-boot>Secure Boot</h3><p>It is highly suggested to enable UEFI secure boot to secure the boot chain all the way to the kernel.</p><p>Debian&rsquo;s <code>grub-efi</code> package comes with <code>shim</code> out of the box signed by Microsoft&rsquo;s third party UEFI CA; it is up to the user to enable it in VM settings.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://qua3k.github.io/tags/hyper-v>hyper-v</a></li><li><a href=https://qua3k.github.io/tags/privacy>privacy</a></li><li><a href=https://qua3k.github.io/tags/security>security</a></li><li><a href=https://qua3k.github.io/tags/whonix>whonix</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://qua3k.github.io/>duck's pond</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hamsters</a>️</span>
<span>&#183;</span>
<span>Theme️ <a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper</a></span></footer><script src=https://qua3k.github.io/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></body></html>