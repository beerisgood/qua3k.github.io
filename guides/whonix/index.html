<!doctype html><html lang=en-us prefix="og: https://ogp.me/ns#">
<head><meta charset=utf-8>
<title>Hacking Whonix Onto Hyper-V &#183; segmentation-fault</title>
<meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name=color-scheme content="light dark">
<meta property="og:type" content="website">
<meta property="og:url" content="https://qua3k.github.io/guides/whonix/">
<link href=https://qua3k.github.io/LICENSE.txt rel=license>
<meta property="og:title" content="Hacking Whonix onto Hyper-V &#183; segmentation-fault">
<meta name=description content="A guide to get Whonix running on Hyper-V.">
<meta property="og:description" content="A guide to get Whonix running on Hyper-V.">
<link rel=icon href=favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta property="og:image" content="/images/apple-touch-icon.png">
<meta property="og:image:alt" content="A picture of a duck">
<link href=https://qua3k.github.io/main.min.css rel=stylesheet>
</head>
<body>
<header><h1><a href=/>segmentation-fault</a></h1></header>
<main>
<h1>Hacking Whonix Onto Hyper-V</h1>
<p class=author>duck
(<a href=https://github.com/qua3k>@qua3k</a>)
<p>This guide aims to get the Whonixâ„¢ operating system running on Hyper-V. This
guide does not expect Virtualbox specific features such as guest additions to
work and does not expend any effort to make them work.</p>
<nav>
<h2 id=#table-of-contents>Table of Contents
<a class=anchor href=#table-of-contents>#</a>
</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#prerequisites>Prerequisites</a>
<ul>
<li><a href=#acquire-the-necessary-tools>Acquire the necessary tools</a></li>
<li><a href=#verify-the-signature>Verify the signature</a></li>
<li><a href=#extract-the-archive>Extract the archive</a></li>
<li><a href=#convert-the-disks>Convert the disks</a></li>
</ul>
</li>
<li><a href=#virtual-machine-setup>Virtual Machine Setup</a>
<ul>
<li><a href=#set-up-networking>Set up networking</a></li>
<li><a href=#create-virtual-machines>Create virtual machines</a></li>
</ul>
</li>
<li><a href=#post-boot-configuration>Post-boot configuration</a></li>
<li><a href=#round-2-working-with-efi>Round 2: Working with EFI</a>
<ul>
<li><a href=#install-grub-efi>Install grub-efi</a></li>
<li><a href=#partitioning>Partitioning</a></li>
</ul>
</li>
<li><a href=#secure-boot>Secure Boot</a></li>
<li><a href=#see-also>See also</a></li>
</ul>
</nav>
</nav>
<h2 id=prerequisites>Prerequisites
<a class=anchor href=#prerequisites>#</a>
</h2>
<h3 id=acquire-the-necessary-tools>Acquire the necessary tools
<a class=anchor href=#acquire-the-necessary-tools>#</a>
</h3>
<ul>
<li><a href=https://www.whonix.org/wiki/VirtualBox>Whonix for VirtualBox</a></li>
<li><a href=https://www.virtualbox.org/wiki/Downloads>VirtualBox for Windows</a></li>
</ul>
<h3 id=verify-the-signature>Verify the signature
<a class=anchor href=#verify-the-signature>#</a>
</h3>
<p>See the <a href=https://www.whonix.org/wiki/Verify_the_Whonix_images>Whonix wiki</a>.</p>
<h3 id=extract-the-archive>Extract the archive
<a class=anchor href=#extract-the-archive>#</a>
</h3>
<p>Use <code>tar</code> or another archive utility of choice to extract the <code>ova</code> archive,
producing two <code>vmdk</code> virtual disks.</p>
<h3 id=convert-the-disks>Convert the disks
<a class=anchor href=#convert-the-disks>#</a>
</h3>
<p>Convert both virtual disks to <code>vhd</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>VBoxManage.exe clonehd source.vmdk target.vhd --format vhd
</code></pre></div><h2 id=virtual-machine-setup>Virtual Machine Setup
<a class=anchor href=#virtual-machine-setup>#</a>
</h2>
<h3 id=set-up-networking>Set up networking
<a class=anchor href=#set-up-networking>#</a>
</h3>
<ul>
<li>
<p>Create an internal switch named WhonixGateway and find its
<a href=https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/setup-nat-network#create-a-nat-virtual-network>interface index</a>.</p>
<ul>
<li>
<p>Create the NAT gateway with the previously mentioned interface index</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>New-NetIPAddress -IPAddress 10.0.2.2 -PrefixLength 24 -InterfaceIndex &lt;ifIndex&gt;
</code></pre></div></li>
<li>
<p>Configure the NAT Network&rsquo;s name and NAT subnet prefix</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>New-NetNat -Name Gateway -InternalIPInterfaceAddressPrefix 10.0.2.0/24
</code></pre></div></li>
</ul>
</li>
<li>
<p>Create a private switch, used to connect Whonix-Gateway to Whonix-Workstation.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>New-VMSwitch -SwitchName WhonixPrivate -SwitchType Private
</code></pre></div></li>
</ul>
<h3 id=create-virtual-machines>Create virtual machines
<a class=anchor href=#create-virtual-machines>#</a>
</h3>
<p>Whonix still uses GRUB&rsquo;s BIOS payload. It isn&rsquo;t UEFI compatible and doesn&rsquo;t run
in Hyper-V&rsquo;s &ldquo;Gen 2&rdquo; VMs, which bring various security improvements. However,
you can attempt to run Whonix in &ldquo;Gen 2&rdquo; VMs here.</p>
<ul>
<li>Create two virtual machines and one virtual disk (<code>whonix-xxxx-disk00x.vhd</code>)
to each.</li>
<li>Create a virtual network adapter on the Whonix-Gateway VM connecting to the
&ldquo;WhonixGateway&rdquo; virtual switch.</li>
<li>Create virtual network adapters on both VMs connecting to the &ldquo;WhonixPrivate&rdquo;
virtual switch.</li>
</ul>
<h2 id=post-boot-configuration>Post-boot configuration
<a class=anchor href=#post-boot-configuration>#</a>
</h2>
<p>We need to load some kernel modules to get networking working on Whonix. See
<a href=https://blog.jitdor.com/2020/02/08/enable-hyper-v-integration-services-for-your-ubuntu-guest-vms/>this link</a>
for more info.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>printf <span style=color:#e6db74>&#34;hv_utils \nhv_vmbus \nhv_storvsc \nhv_blksvc \nhv_netvsc&#34;</span> &gt;&gt; /etc/initramfs-tools/modules
update-initramfs -u
</code></pre></div><h2 id=round-2-working-with-efi>Round 2: Working with EFI
<a class=anchor href=#round-2-working-with-efi>#</a>
</h2>
<p>Turns out EFI is relatively simple; install <code>grub-efi</code> and convert the partition
table to GPT. This next section is for the people who need it.</p>
<blockquote>
<p>Generation 2 virtual machines only support <code>.vhdx</code> disks. You should convert
the disks within the Hyper-V Manager UI or with the PowerShell cmdlet
<code>Convert-VHD</code>.</p>
</blockquote>
<h3 id=install-grub-efi>Install grub-efi
<a class=anchor href=#install-grub-efi>#</a>
</h3>
<p>Boot up your existing Generation 1 virtual machine and install <code>grub-efi-amd64</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>apt update
apt install grub-efi-amd64
apt purge grub-pc-bin
</code></pre></div><h3 id=partitioning>Partitioning
<a class=anchor href=#partitioning>#</a>
</h3>
<ul>
<li>
<p>Resize /dev/sda1 to create some free space for the EFi system partition with <code>cfdisk /dev/sda</code>.</p>
</li>
<li>
<p>Use <code>gdisk /dev/sda</code> to convert the partition table to GPT and create the ESP on <code>/dev/sda2</code>.</p>
</li>
<li>
<p>Format the EFI partition</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mkfs.fat -F <span style=color:#ae81ff>32</span> /dev/sda2
</code></pre></div></li>
<li>
<p>Mount partitions</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>mount /dev/sda1 /mnt
mkdir -p /mnt/boot/efi
mount /dev/sda2 /mnt/boot/efi
<span style=color:#66d9ef>for</span> d in dev proc run sys; <span style=color:#66d9ef>do</span> sudo mount -B /$d /mnt/$d; <span style=color:#66d9ef>done</span>
</code></pre></div></li>
<li>
<p>Finish the GRUB install</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>chroot /mnt
grub-install --target<span style=color:#f92672>=</span>x86_64-efi --efi-directory<span style=color:#f92672>=</span>/boot/efi --bootloader-id<span style=color:#f92672>=</span>DEBIAN
grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></div></li>
<li>
<p>Unmount and reboot</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>umount -R /mnt
reboot
</code></pre></div></li>
</ul>
<h2 id=secure-boot>Secure Boot
<a class=anchor href=#secure-boot>#</a>
</h2>
<p>Debian&rsquo;s <code>grub-efi</code> package comes with <code>shim</code> out of the box signed by Microsoft&rsquo;s third
party UEFI CA; it is up to the user to enable it in VM settings.</p>
<p>Do keep in mind this is mainly theater, as userspace components are not verified.</p>
<h2 id=see-also>See also
<a class=anchor href=#see-also>#</a>
</h2>
<ul>
<li><a href=https://forums.whonix.org>https://forums.whonix.org</a></li>
<li>some link to some hyper-v research</li>
<li>more links to hyper-v research</li>
</ul>
</main>
<footer>
<a href=/posts-list/>a list of all posts</a>
</footer>
</body>
</html>